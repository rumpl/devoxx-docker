<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Managing Namespaces and Root Directory</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/prism.css">
</head>
<body>
    <header>
        <h1>Managing Namespaces and Root Directory</h1>
        <a href="/" class="home-link">‚Üê Back to Index</a>
    </header>
    <main>
        <article class="markdown-content">
            <h1>Managing Namespaces and Root Directory</h1>
<h2>Objective</h2>
<p>Learn how to manage filesystem isolation in a containerized environment by
implementing mount namespaces and changing the root directory using <code>chroot</code>.<br />
This exercise demonstrates how to create a contained filesystem environment.</p>
<h2>Steps</h2>
<h3>Step 1: Add Mount Namespace</h3>
<ol>
<li>Modify the parent process to include mount namespace capability to the child
process:</li>
</ol>
<pre><code class="language-go">func parent() error {
    cmd := exec.Command(&quot;/proc/self/exe&quot;, append([]string{&quot;child&quot;}, os.Args[1:]...)...)

    // TODO:
    // 1. Add the mount namespace flag
}
</code></pre>
<h3>Step 2: Setup Root Directory Structure</h3>
<ol>
<li>Create the function to setup root filesystem:</li>
</ol>
<pre><code class="language-go">func child() error {
    // TODO:
    // 1. Create base rootfs directory at &quot;/fs/container/rootfs&quot;
    // 2. Set appropriate permissions (0755)
    // 3. Handle all potential errors

    return nil
}
</code></pre>
<details>
<summary>Hint</summary>
Look at `os.MkdirAll` function
</details>
<h3>Step 3: Change Root Directory</h3>
<ol>
<li>Implement container root directory setup:</li>
</ol>
<pre><code class="language-go">func setupContainer() error {
    // TODO:
    // 1. Print the current working directory
    // 2. Change root to &quot;/fs/container/rootfs&quot;
    // 3. Change current directory to root (&quot;/&quot;)
    // 4. Handle all potential errors
    // 5. Implement proper error handling
    // 6. Print the new working directory

        return nil
    }
</code></pre>
<details>
<summary>Hint</summary>
Look at `syscall.Chroot` and `os.Chdir` functions
</details>
<h3>Step 4: Testing</h3>
<ol>
<li>Build and run your program:</li>
</ol>
<pre><code class="language-console"># Build the program
make

# Run with sudo (needed for namespace operations)
sudo ./bin/devoxx-container
</code></pre>
<h3>Summary</h3>
<p>We have now implemented mount namespace isolation and changed the root directory
for the container.
This provides a contained filesystem environment for the container.</p>
<p><a href="./03-namespace-isolation.html">Previous step</a> <a href="05-cgroups.html">Next step</a></p>
<h2>Hints</h2>
<ul>
<li>Use <code>syscall.CLONE_NEWNS</code> for mount namespace isolation</li>
<li>Root privileges are required for namespace operations</li>
<li>Use absolute paths when working with directories</li>
<li>Remember to handle cleanup in case of errors</li>
<li>Check if directories exist before operations</li>
<li>Use <code>defer</code> for cleanup operations</li>
</ul>
<h2>Key Points</h2>
<ul>
<li>Mount namespaces provide filesystem isolation</li>
<li><code>chroot</code> changes the root directory view</li>
<li>Proper cleanup is essential to avoid resource leaks</li>
<li>Namespace operations require careful error handling</li>
</ul>
<h2>Additional Resources</h2>
<ul>
<li><a href="https://man7.org/linux/man-pages/man7/mount_namespaces.7.html">man
mount_namespaces</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/chroot.2.html">man chroot</a></li>
<li><a href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs/index.html">Linux Filesystem Hierarchy
Standard</a></li>
</ul>
<h2>Command Reference</h2>
<h3>Namespace Operations</h3>
<pre><code class="language-go">// Create mount namespace
syscall.CLONE_NEWNS

// Change root
syscall.Chroot(path)
</code></pre>
<h3>Debugging Commands</h3>
<pre><code class="language-console"># Check filesystem structure
ls -la /fs/container/rootfs

# View mount namespaces
ls -l /proc/$$/ns/mnt

# View process namespaces
ls -l /proc/$$/ns/
</code></pre>
<h3>Error Handling Examples</h3>
<pre><code class="language-go">// Handle chroot errors
if err := syscall.Chroot(&quot;/fs/container/rootfs&quot;); err != nil {
    if os.IsPermission(err) {
        return fmt.Errorf(&quot;chroot permission denied (run with sudo): %w&quot;, err)
    }
    return fmt.Errorf(&quot;chroot failed: %w&quot;, err)
}

// Handle directory operations
if err := os.MkdirAll(&quot;/path/to/dir&quot;, 0755); err != nil {
    return fmt.Errorf(&quot;failed to create directory: %w&quot;, err)
}
</code></pre>

        </article>
    </main>
    <footer>
        <p>Generated with Markdown Server</p>
    </footer>
    <script src="/static/prism.js"></script>
</body>
</html>